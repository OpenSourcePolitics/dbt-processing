version: 2

models:
  - name: int_users
    schema: "{{ env_var('TARGET_SCHEMA') }}"
    description: ""
    columns:
      - name: id
        description: "The unique identifier for a user"
        tests:
          - unique
          - not_null
      - name: email
        description: "The user's email address"
      - name: nickname
        description: "The user's nickname"
        tests:
          - not_null
      - name: spam
        description: "Indicates if the user has been reported or not"
      - name: spam_probability
        description: "When a user has been reported as spam, gives the coefficient of spam likelihood, comprised between 0 and 1"
        data_tests: 
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              config:
                where: "spam IS NOT null"  
      - name: spam_reported_at
        description: "When a user has been reported as spam, gives the report date"

unit_tests:
  - name: type_check
    description: "Check that the type contains Decidim::User"
    model: int_users
    given:
      - input: ref('stg_decidim_users')
        format: dict
        rows:
          - {id: 1, type: "Decidim::User"}
          - {id: 2, type: "Decidim::Admin"}
          - {id: 3, type: "Decidim::Admin, Decidim::User"}
    expect:
      format: dict
      rows:
          - {id: 1}
  - name: sign_in_frequency_check
    description: "Check that the sign in frequency is properly calculated"
    model: int_users
    given:
      - input: ref('stg_decidim_users')
        format: dict
        rows:
          - {sign_in_count: 0, type: Decidim::User}
          - {sign_in_count: 1, type: Decidim::User}
          - {sign_in_count: 2, type: Decidim::User}
          - {sign_in_count: 3, type: Decidim::User}
          - {sign_in_count: 4, type: Decidim::User}
          - {sign_in_count: 5, type: Decidim::User}
          - {sign_in_count: 6, type: Decidim::User}
          - {sign_in_count: 7, type: Decidim::User}
          - {sign_in_count: 8, type: Decidim::User}
          - {sign_in_count: 9, type: Decidim::User}
          - {sign_in_count: 10, type: Decidim::User}
          - {sign_in_count: 11, type: Decidim::User}
          - {sign_in_count: 100, type: Decidim::User}
    expect:
      format: dict
      rows:
          - {sign_in_frequency: 'Jamais'}
          - {sign_in_frequency: 'Une seule fois'}
          - {sign_in_frequency: 'Deux fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Entre 2 et 10 fois'}
          - {sign_in_frequency: 'Plus de 10 fois'}
          - {sign_in_frequency: 'Plus de 10 fois'}

  - name: spam_detection_check
    description: "Checks if the presence of spam is correctly parsed or not"
    model: int_users
    given:
      - input: ref('stg_decidim_users')
        format: dict
        rows:
          - {id: 1, type: 'Decidim::User', spam_probability: 0.9994} 
          - {id: 2, type: 'Decidim::User', spam_probability: null}        
    expect:
      format: dict
      rows:
          - {id: 1, spam: "true"}
          - {id: 2, spam: "false"}